import Examples.QLearning.AsymmetricLearners.MarkovInternal
import Engine.QLearning.ImportAsymmetricLearners (Action)
import Examples.QLearning.AsymmetricLearners3Phases (Parameters(..),actionSpace1,actionSpace2,randomInitialObservation)
import Engine.QLearning (CTable(..))

import qualified Data.ByteString.Lazy as L -- FIXME
import qualified Formatting.Clock as F
import qualified Formatting.Time as F
import           Path
import qualified Path.IO as IO
import System.Random
import           System.Clock
import           System.Environment
import           System.Exit
import           System.IO hiding (putStrLn)
import           System.Process.Typed
import           UnliftIO.Async


------------------------------------------------
-- This is recreating the game used for learning
-- without _PriceSpace_. This is an interface to
-- the existing runs.
------------------------------------------------

-------------------------
-- Fix variables for Game
-------------------------
-- Player parameters for learning phase
-- Game with low costs
-- Denoted as e1
parametersGame1 :: StdGen -> StdGen -> StdGen -> StdGen -> Parameters
parametersGame1 gEnv1 gEnv2 gObs1 gObs2 = Parameters
  { pKsi = 0.1
  , pBeta =  0.000004
  , pInitialExploreRate1 = ((exp 1) ** 0)
  , pInitialExploreRate2 = ((exp 1) ** 0)
  , pBertrandPrice1 = 1.47
  , pBertrandPrice2 = 1.47
  , pMonopolyPrice1 = 2.62
  , pMonopolyPrice2 = 2.62
  , pGamma = 0.95
  , pLearningRate = 0.15
  , pMu = 0.25
  , pA1 = 2
  , pA2 = 2
  , pA0 = 0
  , pC1 = 1
  , pC2 = 1
  , pM1 = 19 -- NOTE: Due to the construction, we need to take the orginial value of Calvano and take -1
  , pM2 = 19 -- NOTE: Due to the construction, we need to take the orginial value of Calvano and take -1
  , pGeneratorEnv1 = gEnv1
  , pGeneratorEnv2 = gEnv2
  , pGeneratorObs1 = gObs1
  , pGeneratorObs2 = gObs2
  }

-- Denoted as e2
parametersGame2 :: StdGen -> StdGen -> StdGen -> StdGen -> Parameters
parametersGame2 gEnv1 gEnv2 gObs1 gObs2 = Parameters
  { pKsi = 0.1
  , pBeta =  0.000004
  , pInitialExploreRate1 = ((exp 1) ** 0)
  , pInitialExploreRate2 = ((exp 1) ** 0)
  , pBertrandPrice1 = 1.47
  , pBertrandPrice2 = 1.47
  , pMonopolyPrice1 = 2.62
  , pMonopolyPrice2 = 2.62
  , pGamma = 0.95
  , pLearningRate = 0.15
  , pMu = 0.25
  , pA1 = 2.1
  , pA2 = 2.1
  , pA0 = 0
  , pC1 = 1.1
  , pC2 = 1.1
  , pM1 = 19 -- NOTE: Due to the construction, we need to take the orginial value of Calvano and take -1
  , pM2 = 19 -- NOTE: Due to the construction, we need to take the orginial value of Calvano and take -1
  , pGeneratorEnv1 = gEnv1
  , pGeneratorEnv2 = gEnv2
  , pGeneratorObs1 = gObs1
  , pGeneratorObs2 = gObs2
  }


-- Denoted as e3
parametersGame3 :: StdGen -> StdGen -> StdGen -> StdGen -> Parameters
parametersGame3 gEnv1 gEnv2 gObs1 gObs2 = Parameters
  { pKsi = 0.1
  , pBeta =  0.000004
  , pInitialExploreRate1 = ((exp 1) ** 0)
  , pInitialExploreRate2 = ((exp 1) ** 0)
  , pBertrandPrice1 = 1.47
  , pBertrandPrice2 = 1.47
  , pMonopolyPrice1 = 2.62
  , pMonopolyPrice2 = 2.62
  , pGamma = 0.95
  , pLearningRate = 0.15
  , pMu = 0.25
  , pA1 = 2.2
  , pA2 = 2.2
  , pA0 = 0
  , pC1 = 1.2
  , pC2 = 1.2
  , pM1 = 19 -- NOTE: Due to the construction, we need to take the orginial value of Calvano and take -1
  , pM2 = 19 -- NOTE: Due to the construction, we need to take the orginial value of Calvano and take -1
  , pGeneratorEnv1 = gEnv1
  , pGeneratorEnv2 = gEnv2
  , pGeneratorObs1 = gObs1
  , pGeneratorObs2 = gObs2
  }

-- Denoted as e4
parametersGame4 :: StdGen -> StdGen -> StdGen -> StdGen -> Parameters
parametersGame4 gEnv1 gEnv2 gObs1 gObs2 = Parameters
  { pKsi = 0.1
  , pBeta =  0.000004
  , pInitialExploreRate1 = ((exp 1) ** 0)
  , pInitialExploreRate2 = ((exp 1) ** 0)
  , pBertrandPrice1 = 1.47
  , pBertrandPrice2 = 1.47
  , pMonopolyPrice1 = 2.62
  , pMonopolyPrice2 = 2.62
  , pGamma = 0.95
  , pLearningRate = 0.15
  , pMu = 0.25
  , pA1 = 2.3
  , pA2 = 2.3
  , pA0 = 0
  , pC1 = 1.3
  , pC2 = 1.3
  , pM1 = 19 -- NOTE: Due to the construction, we need to take the orginial value of Calvano and take -1
  , pM2 = 19 -- NOTE: Due to the construction, we need to take the orginial value of Calvano and take -1
  , pGeneratorEnv1 = gEnv1
  , pGeneratorEnv2 = gEnv2
  , pGeneratorObs1 = gObs1
  , pGeneratorObs2 = gObs2
  }

-- Denoted as e5
parametersGame5 :: StdGen -> StdGen -> StdGen -> StdGen -> Parameters
parametersGame5 gEnv1 gEnv2 gObs1 gObs2 = Parameters
  { pKsi = 0.1
  , pBeta =  0.000004
  , pInitialExploreRate1 = ((exp 1) ** 0)
  , pInitialExploreRate2 = ((exp 1) ** 0)
  , pBertrandPrice1 = 1.47
  , pBertrandPrice2 = 1.47
  , pMonopolyPrice1 = 2.62
  , pMonopolyPrice2 = 2.62
  , pGamma = 0.95
  , pLearningRate = 0.15
  , pMu = 0.25
  , pA1 = 2.4
  , pA2 = 2.4
  , pA0 = 0
  , pC1 = 1.4
  , pC2 = 1.4
  , pM1 = 19 -- NOTE: Due to the construction, we need to take the orginial value of Calvano and take -1
  , pM2 = 19 -- NOTE: Due to the construction, we need to take the orginial value of Calvano and take -1
  , pGeneratorEnv1 = gEnv1
  , pGeneratorEnv2 = gEnv2
  , pGeneratorObs1 = gObs1
  , pGeneratorObs2 = gObs2
  }


-- Denoted as e6
parametersGame6 :: StdGen -> StdGen -> StdGen -> StdGen -> Parameters
parametersGame6 gEnv1 gEnv2 gObs1 gObs2 = Parameters
  { pKsi = 0.1
  , pBeta =  0.000004
  , pInitialExploreRate1 = ((exp 1) ** 0)
  , pInitialExploreRate2 = ((exp 1) ** 0)
  , pBertrandPrice1 = 1.47
  , pBertrandPrice2 = 1.47
  , pMonopolyPrice1 = 2.62
  , pMonopolyPrice2 = 2.62
  , pGamma = 0.95
  , pLearningRate = 0.15
  , pMu = 0.25
  , pA1 = 2.5
  , pA2 = 2.5
  , pA0 = 0
  , pC1 = 1.5
  , pC2 = 1.5
  , pM1 = 19 -- NOTE: Due to the construction, we need to take the orginial value of Calvano and take -1
  , pM2 = 19 -- NOTE: Due to the construction, we need to take the orginial value of Calvano and take -1
  , pGeneratorEnv1 = gEnv1
  , pGeneratorEnv2 = gEnv2
  , pGeneratorObs1 = gObs1
  , pGeneratorObs2 = gObs2
  }


-- Denoted as e7
parametersGame7 :: StdGen -> StdGen -> StdGen -> StdGen -> Parameters
parametersGame7 gEnv1 gEnv2 gObs1 gObs2 = Parameters
  { pKsi = 0.1
  , pBeta =  0.000004
  , pInitialExploreRate1 = ((exp 1) ** 0)
  , pInitialExploreRate2 = ((exp 1) ** 0)
  , pBertrandPrice1 = 1.47
  , pBertrandPrice2 = 1.47
  , pMonopolyPrice1 = 2.62
  , pMonopolyPrice2 = 2.62
  , pGamma = 0.95
  , pLearningRate = 0.15
  , pMu = 0.25
  , pA1 = 2.6
  , pA2 = 2.6
  , pA0 = 0
  , pC1 = 1.6
  , pC2 = 1.6
  , pM1 = 19 -- NOTE: Due to the construction, we need to take the orginial value of Calvano and take -1
  , pM2 = 19 -- NOTE: Due to the construction, we need to take the orginial value of Calvano and take -1
  , pGeneratorEnv1 = gEnv1
  , pGeneratorEnv2 = gEnv2
  , pGeneratorObs1 = gObs1
  , pGeneratorObs2 = gObs2
  }


-- Denoted as e8
parametersGame8 :: StdGen -> StdGen -> StdGen -> StdGen -> Parameters
parametersGame8 gEnv1 gEnv2 gObs1 gObs2 = Parameters
  { pKsi = 0.1
  , pBeta =  0.000004
  , pInitialExploreRate1 = ((exp 1) ** 0)
  , pInitialExploreRate2 = ((exp 1) ** 0)
  , pBertrandPrice1 = 1.47
  , pBertrandPrice2 = 1.47
  , pMonopolyPrice1 = 2.62
  , pMonopolyPrice2 = 2.62
  , pGamma = 0.95
  , pLearningRate = 0.15
  , pMu = 0.25
  , pA1 = 2.7
  , pA2 = 2.7
  , pA0 = 0
  , pC1 = 1.7
  , pC2 = 1.7
  , pM1 = 19 -- NOTE: Due to the construction, we need to take the orginial value of Calvano and take -1
  , pM2 = 19 -- NOTE: Due to the construction, we need to take the orginial value of Calvano and take -1
  , pGeneratorEnv1 = gEnv1
  , pGeneratorEnv2 = gEnv2
  , pGeneratorObs1 = gObs1
  , pGeneratorObs2 = gObs2
  }

-- Create the relevant keys for the experiments and their specifications
listExperimentIds = [11,12,21,22,31,32,41,42,51,52,61,62,71,72]-- 81,82]

-- map ids to parameters
experimentParameters 11 = parametersGame1
experimentParameters 12 = parametersGame1
experimentParameters 21 = parametersGame2
experimentParameters 22 = parametersGame2
experimentParameters 31 = parametersGame3
experimentParameters 32 = parametersGame3
experimentParameters 41 = parametersGame4
experimentParameters 42 = parametersGame4
experimentParameters 51 = parametersGame5
experimentParameters 52 = parametersGame5
experimentParameters 61 = parametersGame6
experimentParameters 62 = parametersGame6
experimentParameters 71 = parametersGame7
experimentParameters 72 = parametersGame7
experimentParameters 81 = parametersGame8
experimentParameters 82 = parametersGame8

-- source path for all runs of a given experiment
sourcePath exp = fmap (\runNo -> "experiment/e" ++ (show exp) ++ "_phase1_run_" ++ (show runNo) ++ "/") [1..100] -- ..250]

-- path to state index for a given experiment
pathStateIndex exp = "experiment/e" ++ (show exp) ++ "_phase1_run_1/state_action_index_1.csv"

-- path to qmatrix for a given experiment
pathQMatrix exp = fmap (\x -> x ++ "qvalues.csv") (sourcePath exp)

-- path to output for given experiment
outputPath exp = "outputs/equilibria_" ++ (show exp) ++ ".csv" 

iterationsGame = 100

-------------------------------------------
-- Run a single analysis for one experiment
runAnalysis exp = do
  gEnv1 <- newStdGen
  gEnv2 <- newStdGen
  gObs1 <- newStdGen
  gObs2 <- newStdGen
  let par = experimentParameters exp
  importAndAnalyzeEquilibria
    (par gEnv1 gEnv2 gObs1 gObs2)
    iterationsGame
    (outputPath exp)
    (pathStateIndex exp)
    (pathQMatrix exp)

main :: IO ()
main = do
  mapM_ runAnalysis  listExperimentIds

